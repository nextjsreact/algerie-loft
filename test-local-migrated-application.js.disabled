/**
 * Test Local de l'Application MigrÃ©e Next.js 16
 * 
 * Ce script lance l'application migrÃ©e dans le rÃ©pertoire loft-algerie-next16/
 * pour permettre au user de tester l'application en local
 */

import { spawn } from 'child_process'
import { promises as fs } from 'fs'
import { join } from 'path'

class LocalMigratedApplicationTester {
  constructor() {
    this.targetDirectory = 'loft-algerie-next16'
    this.serverProcess = null
    this.serverUrl = 'http://localhost:3000'
  }

  async startLocalTest() {
    console.log('ðŸš€ DÃ©marrage du Test Local de l\'Application MigrÃ©e Next.js 16')
    console.log('='.repeat(80))
    console.log(`ðŸ“ RÃ©pertoire cible: ${this.targetDirectory}`)
    console.log(`ðŸŒ URL de test: ${this.serverUrl}`)
    console.log('='.repeat(80))
    
    try {
      console.log('\nðŸ“‹ Phase 1: VÃ©rification du rÃ©pertoire cible')
      await this.verifyTargetDirectory()
      
      console.log('\nðŸ“‹ Phase 2: VÃ©rification des dÃ©pendances')
      await this.verifyDependencies()
      
      console.log('\nðŸ“‹ Phase 3: DÃ©marrage du serveur de dÃ©veloppement')
      await this.startDevelopmentServer()
      
      console.log('\nðŸ“‹ Phase 4: Instructions pour le test')
      this.displayTestInstructions()
      
      // Garder le processus en vie
      await this.keepServerRunning()
      
    } catch (error) {
      console.error('âŒ Erreur lors du dÃ©marrage du test local:', error.message)
      throw error
    }
  }

  async verifyTargetDirectory() {
    console.log('ðŸ” VÃ©rification du rÃ©pertoire cible...')
    
    try {
      const stats = await fs.stat(this.targetDirectory)
      if (!stats.isDirectory()) {
        throw new Error(`${this.targetDirectory} n'est pas un rÃ©pertoire`)
      }
      
      // VÃ©rifier les fichiers essentiels
      const essentialFiles = [
        'package.json',
        'next.config.mjs',
        'app',
        'components'
      ]
      
      for (const file of essentialFiles) {
        const filePath = join(this.targetDirectory, file)
        try {
          await fs.access(filePath)
          console.log(`     âœ… ${file} trouvÃ©`)
        } catch {
          throw new Error(`Fichier essentiel manquant: ${file}`)
        }
      }
      
      console.log('     âœ… RÃ©pertoire cible validÃ©')
      
    } catch (error) {
      throw new Error(`Erreur de vÃ©rification du rÃ©pertoire: ${error.message}`)
    }
  }

  async verifyDependencies() {
    console.log('ðŸ“¦ VÃ©rification des dÃ©pendances...')
    
    try {
      // VÃ©rifier si node_modules existe
      const nodeModulesPath = join(this.targetDirectory, 'node_modules')
      
      try {
        await fs.access(nodeModulesPath)
        console.log('     âœ… node_modules trouvÃ©')
      } catch {
        console.log('     âš ï¸  node_modules manquant - installation nÃ©cessaire')
        await this.installDependencies()
      }
      
      // VÃ©rifier package.json
      const packageJsonPath = join(this.targetDirectory, 'package.json')
      const packageJson = JSON.parse(await fs.readFile(packageJsonPath, 'utf8'))
      
      console.log(`     âœ… Application: ${packageJson.name}`)
      console.log(`     âœ… Version Next.js: ${packageJson.dependencies?.next || 'Non spÃ©cifiÃ©e'}`)
      
    } catch (error) {
      throw new Error(`Erreur de vÃ©rification des dÃ©pendances: ${error.message}`)
    }
  }

  async installDependencies() {
    console.log('     ðŸ“¥ Installation des dÃ©pendances...')
    
    return new Promise((resolve, reject) => {
      const installProcess = spawn('npm', ['install'], {
        cwd: this.targetDirectory,
        stdio: 'pipe',
        shell: true
      })
      
      let output = ''
      
      installProcess.stdout.on('data', (data) => {
        output += data.toString()
        process.stdout.write('.')
      })
      
      installProcess.stderr.on('data', (data) => {
        output += data.toString()
      })
      
      installProcess.on('close', (code) => {
        console.log('') // Nouvelle ligne aprÃ¨s les points
        
        if (code === 0) {
          console.log('     âœ… DÃ©pendances installÃ©es avec succÃ¨s')
          resolve()
        } else {
          console.log('     âŒ Erreur lors de l\'installation des dÃ©pendances')
          console.log('     Output:', output.slice(-500)) // Derniers 500 caractÃ¨res
          reject(new Error(`Installation failed with code ${code}`))
        }
      })
    })
  }

  async startDevelopmentServer() {
    console.log('ðŸš€ DÃ©marrage du serveur de dÃ©veloppement...')
    
    return new Promise((resolve, reject) => {
      // Utiliser npm run dev pour dÃ©marrer le serveur
      this.serverProcess = spawn('npm', ['run', 'dev'], {
        cwd: this.targetDirectory,
        stdio: 'pipe',
        shell: true
      })
      
      let output = ''
      let serverStarted = false
      
      this.serverProcess.stdout.on('data', (data) => {
        const text = data.toString()
        output += text
        
        // Afficher la sortie en temps rÃ©el
        process.stdout.write(text)
        
        // DÃ©tecter quand le serveur est prÃªt
        if (text.includes('Ready') || text.includes('started server') || text.includes('Local:')) {
          if (!serverStarted) {
            serverStarted = true
            console.log('\\n     âœ… Serveur de dÃ©veloppement dÃ©marrÃ© avec succÃ¨s')
            resolve()
          }
        }
      })
      
      this.serverProcess.stderr.on('data', (data) => {
        const text = data.toString()
        output += text
        process.stderr.write(text)
      })
      
      this.serverProcess.on('close', (code) => {
        if (code !== 0 && !serverStarted) {
          console.log('\\n     âŒ Erreur lors du dÃ©marrage du serveur')
          console.log('     Output:', output.slice(-1000))
          reject(new Error(`Server failed to start with code ${code}`))
        }
      })
      
      // Timeout de 30 secondes pour le dÃ©marrage
      setTimeout(() => {
        if (!serverStarted) {
          console.log('\\n     âš ï¸  Le serveur prend du temps Ã  dÃ©marrer...')
          console.log('     âœ… ConsidÃ©rÃ© comme dÃ©marrÃ© (timeout)')
          resolve()
        }
      }, 30000)
    })
  }

  displayTestInstructions() {
    console.log('\\n' + '='.repeat(80))
    console.log('ðŸŽ¯ INSTRUCTIONS POUR TESTER L\'APPLICATION MIGRÃ‰E')
    console.log('='.repeat(80))
    
    console.log('\\nðŸ“± Application Next.js 16 MigrÃ©e Disponible:')
    console.log(`   ðŸŒ URL: ${this.serverUrl}`)
    console.log('   ðŸ“ RÃ©pertoire: loft-algerie-next16/')
    
    console.log('\\nðŸ§ª Tests Ã  Effectuer:')
    console.log('   1. âœ… Navigation gÃ©nÃ©rale de l\'application')
    console.log('   2. âœ… FonctionnalitÃ©s de recherche de lofts')
    console.log('   3. âœ… Processus de rÃ©servation')
    console.log('   4. âœ… Interface partenaires (si accessible)')
    console.log('   5. âœ… Changement de langue (fr/en/ar)')
    console.log('   6. âœ… ResponsivitÃ© mobile')
    console.log('   7. âœ… Performance gÃ©nÃ©rale')
    
    console.log('\\nðŸ” Points d\'Attention:')
    console.log('   â€¢ VÃ©rifier que toutes les fonctionnalitÃ©s de l\'app source fonctionnent')
    console.log('   â€¢ Tester les traductions multilingues')
    console.log('   â€¢ Valider la responsivitÃ© sur diffÃ©rentes tailles d\'Ã©cran')
    console.log('   â€¢ ContrÃ´ler les performances (temps de chargement)')
    
    console.log('\\nâš ï¸  Important:')
    console.log('   â€¢ Cette application est la VERSION MIGRÃ‰E vers Next.js 16')
    console.log('   â€¢ Elle doit avoir les mÃªmes fonctionnalitÃ©s que l\'application source')
    console.log('   â€¢ Signalez tout problÃ¨me ou diffÃ©rence observÃ©e')
    
    console.log('\\nðŸ›‘ Pour ArrÃªter le Test:')
    console.log('   â€¢ Appuyez sur Ctrl+C dans ce terminal')
    console.log('   â€¢ Ou fermez cette fenÃªtre de terminal')
    
    console.log('\\n' + '='.repeat(80))
    console.log('ðŸš€ L\'application est maintenant accessible pour vos tests!')
    console.log('='.repeat(80))
  }

  async keepServerRunning() {
    console.log('\\nâ³ Serveur en cours d\'exÃ©cution... (Ctrl+C pour arrÃªter)')
    
    // GÃ©rer l'arrÃªt propre
    process.on('SIGINT', () => {
      console.log('\\n\\nðŸ›‘ ArrÃªt du serveur de test...')
      
      if (this.serverProcess) {
        this.serverProcess.kill('SIGTERM')
        
        setTimeout(() => {
          if (this.serverProcess && !this.serverProcess.killed) {
            this.serverProcess.kill('SIGKILL')
          }
        }, 5000)
      }
      
      console.log('âœ… Test local terminÃ©')
      process.exit(0)
    })
    
    // Garder le processus en vie
    return new Promise(() => {
      // Cette promesse ne se rÃ©sout jamais, gardant le processus actif
    })
  }
}

// DÃ©marrer le test local
async function runLocalMigratedApplicationTest() {
  const tester = new LocalMigratedApplicationTester()
  
  try {
    await tester.startLocalTest()
  } catch (error) {
    console.error('\\nðŸ’¥ Ã‰chec du test local:', error.message)
    console.log('\\nðŸ”§ Solutions possibles:')
    console.log('   1. VÃ©rifiez que Node.js est installÃ©')
    console.log('   2. VÃ©rifiez que le rÃ©pertoire loft-algerie-next16/ existe')
    console.log('   3. Essayez de lancer manuellement: cd loft-algerie-next16 && npm install && npm run dev')
    process.exit(1)
  }
}

// Lancer le test
runLocalMigratedApplicationTest()