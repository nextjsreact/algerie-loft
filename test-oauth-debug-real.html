<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test OAuth Debug - Diagnostic R√©el</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .step { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .error { background: #f8d7da; border-left-color: #dc3545; }
        .success { background: #d4edda; border-left-color: #28a745; }
        .warning { background: #fff3cd; border-left-color: #ffc107; }
        .code { background: #e9ecef; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; white-space: pre-wrap; }
        .btn { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin: 5px; }
        .btn:hover { background: #0056b3; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>üîç Diagnostic OAuth R√©el - √âtape par √âtape</h1>
    
    <div class="error step">
        <h3>‚ùå Probl√®me Persistant</h3>
        <p>OAuth continue de rediriger vers la page d'accueil au lieu du dashboard</p>
        <p><strong>Diagnostic n√©cessaire :</strong> V√©rifier chaque √©tape du flux OAuth</p>
    </div>

    <div class="step">
        <h3>üîç √âtape 1: V√©rifier la Configuration Supabase</h3>
        <p>V√©rifiez dans Supabase Dashboard ‚Üí Authentication ‚Üí URL Configuration :</p>
        <div class="code">Site URL: https://loftalgerie.com
Redirect URLs:
- https://loftalgerie.com/fr/auth/callback
- https://loftalgerie.com/en/auth/callback
- https://loftalgerie.com/ar/auth/callback</div>
        <button class="btn" onclick="checkSupabaseConfig()">V√©rifier Config Supabase</button>
    </div>

    <div class="step">
        <h3>üîç √âtape 2: Tester l'URL de Redirection OAuth</h3>
        <p>Simuler le clic OAuth pour voir l'URL g√©n√©r√©e :</p>
        <button class="btn" onclick="testOAuthURL()">Tester URL OAuth</button>
        <div id="oauth-url-result"></div>
    </div>

    <div class="step">
        <h3>üîç √âtape 3: V√©rifier les Cookies</h3>
        <p>V√©rifier si les cookies sont cr√©√©s correctement :</p>
        <button class="btn" onclick="checkCookies()">V√©rifier Cookies</button>
        <div id="cookies-result"></div>
    </div>

    <div class="step">
        <h3>üîç √âtape 4: Tester la Session Supabase</h3>
        <p>V√©rifier si la session Supabase est active :</p>
        <button class="btn" onclick="checkSupabaseSession()">V√©rifier Session</button>
        <div id="session-result"></div>
    </div>

    <div class="step">
        <h3>üîç √âtape 5: Diagnostic Complet</h3>
        <p>Ex√©cuter tous les tests en une fois :</p>
        <button class="btn" onclick="runFullDiagnostic()">Diagnostic Complet</button>
        <div id="full-diagnostic-result"></div>
    </div>

    <div class="warning step">
        <h3>‚ö†Ô∏è Actions Correctives Possibles</h3>
        <div id="corrective-actions">
            <p>Les actions correctives appara√Ætront ici apr√®s le diagnostic...</p>
        </div>
    </div>

    <div id="results"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuration Supabase
        const supabaseUrl = 'https://mhngbluefyucoesgcjoy.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1obmdibHVlZnl1Y29lc2djam95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMzE3MjIsImV4cCI6MjA2MTcwNzcyMn0.buEObYOAzS8eCKZ6tti0gER1Xh1pjmEAMbDJVnX5WDU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `step ${type}`;
            div.innerHTML = `<p><strong>${new Date().toLocaleTimeString()}</strong>: ${message}</p>`;
            results.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function checkSupabaseConfig() {
            log('üîç V√©rification de la configuration Supabase...', 'info');
            
            const currentDomain = window.location.hostname;
            const expectedDomain = 'loftalgerie.com';
            
            if (currentDomain === expectedDomain) {
                log('‚úÖ Domaine correct: ' + currentDomain, 'success');
            } else {
                log('‚ö†Ô∏è Domaine actuel: ' + currentDomain + ' (attendu: ' + expectedDomain + ')', 'warning');
            }
            
            // V√©rifier l'URL Supabase
            log('üìç URL Supabase: ' + supabaseUrl, 'info');
            log('üîë Cl√© Supabase: ' + supabaseKey.substring(0, 20) + '...', 'info');
            
            document.getElementById('oauth-url-result').innerHTML = `
                <div class="code">Domaine actuel: ${currentDomain}
URL Supabase: ${supabaseUrl}
Status: ${currentDomain === expectedDomain ? '‚úÖ OK' : '‚ö†Ô∏è V√©rifier'}</div>
            `;
        }

        function testOAuthURL() {
            log('üîç Test de l\'URL OAuth...', 'info');
            
            const locale = 'fr';
            const role = 'client';
            const expectedURL = `${window.location.origin}/${locale}/auth/callback?role=${role}`;
            
            log('üìç URL de redirection attendue: ' + expectedURL, 'info');
            
            // Simuler la g√©n√©ration d'URL OAuth
            const oauthParams = new URLSearchParams({
                response_type: 'code',
                client_id: 'google-client-id',
                redirect_uri: expectedURL,
                scope: 'openid email profile'
            });
            
            const simulatedOAuthURL = `https://accounts.google.com/oauth/authorize?${oauthParams}`;
            
            document.getElementById('oauth-url-result').innerHTML = `
                <div class="code">URL de callback g√©n√©r√©e: ${expectedURL}
URL OAuth simul√©e: ${simulatedOAuthURL}</div>
            `;
            
            log('‚úÖ URL OAuth g√©n√©r√©e avec succ√®s', 'success');
        }

        function checkCookies() {
            log('üîç V√©rification des cookies...', 'info');
            
            const cookies = document.cookie.split(';').map(c => c.trim());
            const authCookies = cookies.filter(c => c.includes('sb-') || c.includes('login_context'));
            
            log('üç™ Cookies trouv√©s: ' + cookies.length, 'info');
            log('üîê Cookies d\'auth: ' + authCookies.length, 'info');
            
            const loginContext = cookies.find(c => c.startsWith('login_context='));
            
            let result = `<div class="code">Tous les cookies (${cookies.length}):
${cookies.join('\n')}

Cookies d'authentification (${authCookies.length}):
${authCookies.join('\n')}

Login Context: ${loginContext || 'Non trouv√©'}</div>`;
            
            document.getElementById('cookies-result').innerHTML = result;
            
            if (loginContext) {
                log('‚úÖ Cookie login_context trouv√©: ' + loginContext, 'success');
            } else {
                log('‚ùå Cookie login_context manquant', 'error');
            }
        }

        async function checkSupabaseSession() {
            log('üîç V√©rification de la session Supabase...', 'info');
            
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    log('‚ùå Erreur session: ' + error.message, 'error');
                    document.getElementById('session-result').innerHTML = `
                        <div class="code error">Erreur: ${error.message}</div>
                    `;
                    return;
                }
                
                if (session) {
                    log('‚úÖ Session active pour: ' + session.user.email, 'success');
                    
                    // V√©rifier le r√¥le
                    const userRole = session.user.user_metadata?.role || 'Non d√©fini';
                    log('üë§ R√¥le utilisateur: ' + userRole, 'info');
                    
                    document.getElementById('session-result').innerHTML = `
                        <div class="code success">‚úÖ Session active
Email: ${session.user.email}
ID: ${session.user.id}
R√¥le: ${userRole}
Cr√©√©e: ${new Date(session.user.created_at).toLocaleString()}
Expire: ${new Date(session.expires_at * 1000).toLocaleString()}</div>
                    `;
                } else {
                    log('‚ùå Aucune session active', 'error');
                    document.getElementById('session-result').innerHTML = `
                        <div class="code error">‚ùå Aucune session Supabase active</div>
                    `;
                }
            } catch (err) {
                log('‚ùå Exception session: ' + err.message, 'error');
                document.getElementById('session-result').innerHTML = `
                    <div class="code error">Exception: ${err.message}</div>
                `;
            }
        }

        async function runFullDiagnostic() {
            log('üöÄ D√©marrage du diagnostic complet...', 'info');
            
            // Nettoyer les r√©sultats pr√©c√©dents
            document.getElementById('results').innerHTML = '';
            
            // Ex√©cuter tous les tests
            checkSupabaseConfig();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testOAuthURL();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            checkCookies();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await checkSupabaseSession();
            
            // G√©n√©rer les actions correctives
            generateCorrectiveActions();
            
            log('‚úÖ Diagnostic complet termin√©', 'success');
        }

        function generateCorrectiveActions() {
            const currentDomain = window.location.hostname;
            const hasSession = document.getElementById('session-result').innerHTML.includes('‚úÖ Session active');
            const hasLoginContext = document.cookie.includes('login_context=');
            
            let actions = '<h4>üîß Actions Correctives Recommand√©es:</h4><ul>';
            
            if (currentDomain !== 'loftalgerie.com') {
                actions += '<li><strong>Domaine:</strong> Testez sur https://loftalgerie.com au lieu de ' + currentDomain + '</li>';
            }
            
            if (!hasSession) {
                actions += '<li><strong>Session:</strong> Connectez-vous d\'abord avec email/password pour tester</li>';
            }
            
            if (!hasLoginContext) {
                actions += '<li><strong>Cookie:</strong> Le cookie login_context n\'est pas cr√©√© - probl√®me dans le callback</li>';
            }
            
            actions += '<li><strong>Supabase:</strong> V√©rifiez que les Redirect URLs sont configur√©es dans Supabase Dashboard</li>';
            actions += '<li><strong>Logs:</strong> V√©rifiez les logs de la console lors du test OAuth</li>';
            actions += '<li><strong>Network:</strong> V√©rifiez l\'onglet Network des DevTools pour voir les redirections</li>';
            actions += '</ul>';
            
            document.getElementById('corrective-actions').innerHTML = actions;
        }

        // Auto-run au chargement de la page
        window.onload = function() {
            log('üîç Page de diagnostic charg√©e', 'info');
            log('üìç URL actuelle: ' + window.location.href, 'info');
            log('üåê Domaine: ' + window.location.hostname, 'info');
        };
    </script>
</body>
</html>