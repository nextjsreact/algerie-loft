<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug OAuth Issue</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .debug-section { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .error { background: #f8d7da; border-left-color: #dc3545; }
        .warning { background: #fff3cd; border-left-color: #ffc107; }
        .success { background: #d4edda; border-left-color: #28a745; }
        .code { background: #e9ecef; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
        .btn { display: inline-block; padding: 8px 16px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; margin: 5px; }
        .btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üîç Debug OAuth Redirection Issue</h1>
    
    <div class="error debug-section">
        <h3>‚ùå Probl√®me Identifi√©</h3>
        <p><strong>Sympt√¥me :</strong> OAuth redirige vers la page d'accueil au lieu du dashboard</p>
        <p><strong>Cause probable :</strong> Conflit entre la logique de redirection du callback OAuth et la page d'accueil</p>
    </div>

    <div class="debug-section">
        <h3>üîç Points de Diagnostic</h3>
        <ol>
            <li><strong>URL de callback :</strong> V√©rifier que Supabase redirige bien vers <code>/api/auth/callback</code></li>
            <li><strong>Param√®tres URL :</strong> V√©rifier que <code>role</code> et <code>next</code> sont pr√©sents</li>
            <li><strong>Cookie creation :</strong> V√©rifier que <code>login_context</code> est cr√©√©</li>
            <li><strong>Page d'accueil :</strong> V√©rifier qu'elle ne redirige pas incorrectement</li>
        </ol>
    </div>

    <div class="warning debug-section">
        <h3>‚ö†Ô∏è Probl√®mes Potentiels Identifi√©s</h3>
        
        <h4>1. Page d'accueil interf√®re</h4>
        <p>La page <code>app/[locale]/page.tsx</code> a sa propre logique de redirection qui peut entrer en conflit.</p>
        
        <h4>2. Cookie timing</h4>
        <p>Le cookie <code>login_context</code> n'est peut-√™tre pas cr√©√© √† temps ou pas lu correctement.</p>
        
        <h4>3. Redirection en boucle</h4>
        <p>Possible conflit entre le callback et la page d'accueil.</p>
    </div>

    <div class="debug-section">
        <h3>üß™ Tests √† Effectuer</h3>
        
        <h4>Test 1: V√©rifier l'URL de callback</h4>
        <div class="code">
1. Ouvrir les DevTools (F12)
2. Aller sur /login
3. Cliquer OAuth
4. V√©rifier l'URL finale dans Network tab
5. Chercher: /api/auth/callback?code=...&role=...
        </div>
        
        <h4>Test 2: V√©rifier les cookies</h4>
        <div class="code">
1. Apr√®s OAuth, ouvrir DevTools
2. Application tab ‚Üí Cookies
3. Chercher: login_context
4. V√©rifier la valeur (client/partner/employee)
        </div>
        
        <h4>Test 3: V√©rifier les logs</h4>
        <div class="code">
1. Ouvrir Console (F12)
2. Faire OAuth login
3. Chercher les logs: [OAuth Callback]
4. V√©rifier la logique de redirection
        </div>
    </div>

    <div class="success debug-section">
        <h3>üîß Solutions √† Tester</h3>
        
        <h4>Solution 1: Forcer la redirection dans le callback</h4>
        <p>Modifier le callback pour √©viter la page d'accueil compl√®tement</p>
        
        <h4>Solution 2: D√©sactiver la redirection de la page d'accueil pour OAuth</h4>
        <p>Ajouter une condition pour ignorer la redirection si on vient d'OAuth</p>
        
        <h4>Solution 3: Utiliser une page de callback d√©di√©e</h4>
        <p>Cr√©er une page interm√©diaire qui g√®re la redirection</p>
    </div>

    <div class="debug-section">
        <h3>üìã Checklist de Debug</h3>
        <ul>
            <li>‚òê Configuration Supabase v√©rifi√©e (URLs correctes)</li>
            <li>‚òê Param√®tres URL du callback v√©rifi√©s</li>
            <li>‚òê Cookie login_context cr√©√© et lu</li>
            <li>‚òê Logs du callback examin√©s</li>
            <li>‚òê Conflit avec page d'accueil identifi√©</li>
            <li>‚òê Solution appliqu√©e et test√©e</li>
        </ul>
    </div>

    <div class="debug-section">
        <h3>üîó URLs de Test</h3>
        <p><strong>Login :</strong> <a href="https://loftalgerie.com/login" target="_blank">https://loftalgerie.com/login</a></p>
        <p><strong>Callback :</strong> <code>https://loftalgerie.com/api/auth/callback</code></p>
        <p><strong>Dashboard Client :</strong> <a href="https://loftalgerie.com/fr/client/dashboard" target="_blank">https://loftalgerie.com/fr/client/dashboard</a></p>
    </div>

    <script>
        console.log('üîç OAuth Debug Page Loaded');
        console.log('üìç Current URL:', window.location.href);
        console.log('üç™ Current cookies:', document.cookie);
        
        // V√©rifier les cookies OAuth
        const cookies = document.cookie.split(';').map(c => c.trim());
        const authCookies = cookies.filter(c => c.includes('sb-') || c.includes('login_context'));
        console.log('üîê Auth cookies:', authCookies);
        
        // V√©rifier le localStorage Supabase
        const supabaseSession = localStorage.getItem('sb-mhngbluefyucoesgcjoy-auth-token');
        console.log('üíæ Supabase session:', !!supabaseSession);
        
        if (supabaseSession) {
            try {
                const session = JSON.parse(supabaseSession);
                console.log('üë§ User email:', session.user?.email);
                console.log('üé≠ User role:', session.user?.user_metadata?.role);
            } catch (e) {
                console.log('‚ùå Error parsing session:', e);
            }
        }
    </script>
</body>
</html>