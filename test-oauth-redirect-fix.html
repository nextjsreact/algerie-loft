<!DOCTYPE html>
<html>
<head>
    <title>Test OAuth Redirect Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Test OAuth Redirect Fix</h1>
    
    <div class="test-section info">
        <h2>Configuration actuelle</h2>
        <p><strong>URL actuelle:</strong> <span id="currentUrl"></span></p>
        <p><strong>Environnement:</strong> <span id="environment"></span></p>
    </div>
    
    <div class="test-section">
        <h2>Test 1: V√©rification des URLs de redirection</h2>
        <div id="urlTest"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: OAuth avec diff√©rents r√¥les</h2>
        <button onclick="testOAuth('client')">Test OAuth Client</button>
        <button onclick="testOAuth('partner')">Test OAuth Partner</button>
        <button onclick="testOAuth('admin')">Test OAuth Admin</button>
        <div id="oauthResults"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: V√©rification du middleware</h2>
        <button onclick="testMiddleware()">Test Middleware</button>
        <div id="middlewareResults"></div>
    </div>
    
    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2'
        
        const supabaseUrl = 'https://mhngbluefyucoesgcjoy.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1obmdibHVlZnl1Y29lc2djam95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMzE3MjIsImV4cCI6MjA2MTcwNzcyMn0.buEObYOAzS8eCKZ6tti0gER1Xh1pjmEAMbDJVnX5WDU'
        
        const supabase = createClient(supabaseUrl, supabaseKey)
        
        // Initialisation
        document.getElementById('currentUrl').textContent = window.location.origin
        document.getElementById('environment').textContent = window.location.hostname === 'localhost' ? 'D√©veloppement' : 'Production'
        
        // Test 1: URLs de redirection
        const urlTest = document.getElementById('urlTest')
        const currentOrigin = window.location.origin
        const expectedUrls = [
            `${currentOrigin}/api/auth/callback`,
            'https://loftalgerie.com/api/auth/callback'
        ]
        
        urlTest.innerHTML = '<h3>URLs de redirection attendues:</h3>'
        expectedUrls.forEach(url => {
            urlTest.innerHTML += `<p>‚úì ${url}</p>`
        })
        
        // Test OAuth function
        window.testOAuth = async function(role) {
            const results = document.getElementById('oauthResults')
            results.innerHTML += `<h3>Test OAuth pour r√¥le: ${role}</h3>`
            
            const redirectUrl = `${currentOrigin}/api/auth/callback?next=/fr&role=${role}`
            results.innerHTML += `<p><strong>URL de redirection:</strong> ${redirectUrl}</p>`
            
            try {
                results.innerHTML += '<p>üîÑ Tentative OAuth Google...</p>'
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: redirectUrl
                    }
                })
                
                if (error) {
                    results.innerHTML += `<p style="color: red;">‚ùå Erreur: ${error.message}</p>`
                } else {
                    results.innerHTML += '<p style="color: green;">‚úÖ OAuth initi√© - redirection en cours...</p>'
                }
            } catch (err) {
                results.innerHTML += `<p style="color: red;">‚ùå Exception: ${err.message}</p>`
            }
        }
        
        // Test Middleware function
        window.testMiddleware = async function() {
            const results = document.getElementById('middlewareResults')
            results.innerHTML = '<h3>Test du middleware</h3>'
            
            try {
                // Test 1: Route API auth
                results.innerHTML += '<p>üîÑ Test route /api/auth/callback...</p>'
                const response1 = await fetch('/api/auth/callback', { method: 'HEAD' })
                results.innerHTML += `<p>Status: ${response1.status} - ${response1.status === 400 ? '‚úÖ Route accessible' : '‚ùå Route bloqu√©e'}</p>`
                
                // Test 2: Route normale
                results.innerHTML += '<p>üîÑ Test route normale...</p>'
                const response2 = await fetch('/fr', { method: 'HEAD' })
                results.innerHTML += `<p>Status: ${response2.status} - ${response2.status === 200 ? '‚úÖ Route normale OK' : '‚ùå Probl√®me route'}</p>`
                
            } catch (err) {
                results.innerHTML += `<p style="color: red;">‚ùå Erreur test middleware: ${err.message}</p>`
            }
        }
        
        // Instructions
        const instructions = document.createElement('div')
        instructions.className = 'test-section info'
        instructions.innerHTML = `
            <h2>Instructions pour corriger OAuth</h2>
            <ol>
                <li><strong>Ajouter dans Supabase Redirect URLs:</strong>
                    <ul>
                        <li>http://localhost:3000/api/auth/callback</li>
                        <li>https://localhost:3000/api/auth/callback (si HTTPS local)</li>
                    </ul>
                </li>
                <li><strong>V√©rifier que le middleware exclut /api/auth/</strong></li>
                <li><strong>Tester OAuth avec les boutons ci-dessus</strong></li>
                <li><strong>V√©rifier les logs du callback dans la console</strong></li>
            </ol>
        `
        document.body.appendChild(instructions)
    </script>
</body>
</html>