<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test OAuth Simple</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .step { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #f8d7da; }
        .success { background: #d4edda; }
        .code { background: #e9ecef; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
        .btn { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin: 5px; cursor: pointer; border: none; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Test OAuth Simple - Diagnostic Direct</h1>
    
    <div class="step">
        <h3>ğŸ“ Ã‰tape 1: VÃ©rifier l'URL actuelle</h3>
        <div class="code" id="current-url"></div>
    </div>

    <div class="step">
        <h3>ğŸ” Ã‰tape 2: VÃ©rifier les paramÃ¨tres URL</h3>
        <div class="code" id="url-params"></div>
    </div>

    <div class="step">
        <h3>ğŸª Ã‰tape 3: VÃ©rifier les cookies</h3>
        <div class="code" id="cookies-info"></div>
    </div>

    <div class="step">
        <h3>ğŸ§ª Ã‰tape 4: Test de redirection manuelle</h3>
        <p>Testez les redirections manuellement :</p>
        <button class="btn" onclick="testRedirect('client')">Test Client Dashboard</button>
        <button class="btn" onclick="testRedirect('partner')">Test Partner Dashboard</button>
        <button class="btn" onclick="testRedirect('employee')">Test Employee Dashboard</button>
    </div>

    <div class="step">
        <h3>ğŸ”§ Ã‰tape 5: Forcer la crÃ©ation du cookie</h3>
        <p>CrÃ©er manuellement le cookie login_context :</p>
        <button class="btn" onclick="setCookie('client')">Set Client Context</button>
        <button class="btn" onclick="setCookie('partner')">Set Partner Context</button>
        <button class="btn" onclick="setCookie('employee')">Set Employee Context</button>
    </div>

    <div class="step">
        <h3>ğŸ“‹ RÃ©sultats des tests</h3>
        <div id="test-results"></div>
    </div>

    <script>
        function log(message) {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.innerHTML = `<p><strong>${new Date().toLocaleTimeString()}</strong>: ${message}</p>`;
            results.appendChild(div);
            console.log(message);
        }

        function displayCurrentInfo() {
            // URL actuelle
            document.getElementById('current-url').textContent = window.location.href;
            
            // ParamÃ¨tres URL
            const params = new URLSearchParams(window.location.search);
            let paramsText = 'ParamÃ¨tres URL:\n';
            for (const [key, value] of params) {
                paramsText += `${key}: ${value}\n`;
            }
            if (params.size === 0) {
                paramsText += 'Aucun paramÃ¨tre URL';
            }
            document.getElementById('url-params').textContent = paramsText;
            
            // Cookies
            const cookies = document.cookie.split(';').map(c => c.trim());
            let cookiesText = 'Cookies:\n';
            cookies.forEach(cookie => {
                if (cookie.includes('login_context') || cookie.includes('sb-')) {
                    cookiesText += `${cookie}\n`;
                }
            });
            if (cookies.length === 0 || !cookiesText.includes('login_context')) {
                cookiesText += '\nâŒ Cookie login_context non trouvÃ©';
            }
            document.getElementById('cookies-info').textContent = cookiesText;
        }

        function testRedirect(role) {
            log(`ğŸ§ª Test de redirection pour le rÃ´le: ${role}`);
            
            const locale = 'fr';
            let targetUrl;
            
            switch (role) {
                case 'client':
                    targetUrl = `/${locale}/client/dashboard`;
                    break;
                case 'partner':
                    targetUrl = `/${locale}/partner/dashboard`;
                    break;
                case 'employee':
                    targetUrl = `/${locale}/dashboard`;
                    break;
                default:
                    targetUrl = `/${locale}/dashboard`;
            }
            
            log(`ğŸ“ Redirection vers: ${targetUrl}`);
            
            // Test si la page existe
            fetch(targetUrl, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        log(`âœ… Page ${targetUrl} accessible`);
                        // Rediriger aprÃ¨s 2 secondes
                        setTimeout(() => {
                            window.location.href = targetUrl;
                        }, 2000);
                    } else {
                        log(`âŒ Page ${targetUrl} non accessible (${response.status})`);
                    }
                })
                .catch(err => {
                    log(`âŒ Erreur lors du test de ${targetUrl}: ${err.message}`);
                });
        }

        function setCookie(context) {
            log(`ğŸª CrÃ©ation du cookie login_context=${context}`);
            
            // CrÃ©er le cookie
            document.cookie = `login_context=${context}; path=/; max-age=${60*60*24*7}; SameSite=Lax`;
            
            // VÃ©rifier que le cookie a Ã©tÃ© crÃ©Ã©
            setTimeout(() => {
                if (document.cookie.includes(`login_context=${context}`)) {
                    log(`âœ… Cookie login_context=${context} crÃ©Ã© avec succÃ¨s`);
                    displayCurrentInfo(); // RafraÃ®chir l'affichage des cookies
                } else {
                    log(`âŒ Ã‰chec de la crÃ©ation du cookie login_context=${context}`);
                }
            }, 100);
        }

        // VÃ©rifier si on est sur une page de callback
        function checkIfCallbackPage() {
            const url = window.location.href;
            const isCallback = url.includes('/auth/callback') || url.includes('/api/auth/callback');
            
            if (isCallback) {
                log('ğŸ“ Vous Ãªtes sur une page de callback OAuth');
                
                // VÃ©rifier les paramÃ¨tres
                const params = new URLSearchParams(window.location.search);
                const code = params.get('code');
                const role = params.get('role');
                const error = params.get('error');
                
                if (error) {
                    log(`âŒ Erreur OAuth: ${error}`);
                } else if (code) {
                    log(`âœ… Code OAuth reÃ§u: ${code.substring(0, 20)}...`);
                    log(`ğŸ­ RÃ´le sÃ©lectionnÃ©: ${role || 'Non spÃ©cifiÃ©'}`);
                } else {
                    log(`âš ï¸ Page de callback sans code OAuth`);
                }
            } else {
                log('ğŸ“ Vous n\'Ãªtes pas sur une page de callback');
            }
        }

        // Auto-run au chargement
        window.onload = function() {
            displayCurrentInfo();
            checkIfCallbackPage();
            log('ğŸ” Page de test OAuth chargÃ©e');
        };
    </script>
</body>
</html>